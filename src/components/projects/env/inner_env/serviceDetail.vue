<template>
  <div class="service-details-container">
    <el-dialog :visible.sync="ephemeralContainersDialog.visible" title="启动调试容器" width="600px" :close-on-click-modal="false" class="ephemeralContainers-dialog" :show-close="false" append-to-body>
      <el-alert style="background: #fff;" title="调试容器正常启动后，点击「调试」按钮可对服务进行诊断" type="info" :closable="false"></el-alert>
      <el-form ref="ephemeralContainerForm" :model="ephemeralContainersDialog" label-width="90px">
        <el-form-item label="镜像来源">
          <el-select style="width: 100%;" v-model="ephemeralContainersDialog.source" size="small" placeholder="请选择镜像来源">
            <el-option label="使用内置镜像" value="builtin"> </el-option>
            <el-option label="使用自定义镜像" value="custom"> </el-option>
          </el-select>
        </el-form-item>
        <el-form-item v-if="ephemeralContainersDialog.source === 'custom'" prop="image" :rules="{required: true, message: '镜像名称不能为空', trigger: ['blur', 'change']}" label="镜像名称">
          <el-input size="small" v-model="ephemeralContainersDialog.image" placeholder="请输入调试容器使用的镜像名称"></el-input>
        </el-form-item>
      </el-form>
      <el-alert  v-if="ephemeralContainersDialog.source === 'builtin'" :closable="false" type="warning">
        <span slot="title">
          <span>内置镜像包含以下诊断工具：</span><br>
          <span>curl、wget、iputils-ping、telnet、dnsutils、tcpdump、net-tools、procps、sysstat</span>
        </span>
      </el-alert>
      <div slot="footer">
        <el-button @click="ephemeralContainersDialog.visible = false" size="small">取 消</el-button>
        <el-button type="primary" @click="startEphemeralContainersDebug" size="small">确 定</el-button>
      </div>
    </el-dialog>
    <div class="info-card">
      <div class="info-header">
        <span>基本信息</span>
      </div>
      <el-row :gutter="0"
              class="info-body">
        <el-col :span="12"
                class="WAN">
          <div class="addr-title title">
            外网访问
          </div>
          <div class="addr-content">
            <template v-if="allHosts.length > 0">
              <div v-for="host of allHosts"
                   :key="host.host">
                <a :href="`http://${host.host}`"
                   target="_blank">{{ host.host }}</a>
              </div>
            </template>
            <div v-else>无</div>
          </div>
        </el-col>
        <el-col :span="12"
                class="LAN">
          <div class="addr-title title">
            内网访问
          </div>
          <div class="addr-content">
            <template v-if="allEndpoints.length > 0">
              <div v-for="(ep,index) in allEndpoints"
                   :key="index">
                <span>{{ `${ep.service_name}:${ep.service_port}` }}</span>
                <el-popover v-if="index===0"
                            placement="bottom"
                            popper-class="ns-pop"
                            trigger="hover">
                  <span class="title">同 NS 访问：</span>
                  <div v-for="(sameNs,indexSame) in allEndpoints"
                       :key="indexSame+'same'">
                    <span class="addr">{{ `${sameNs.service_name}:${sameNs.service_port}` }}</span>
                    <span v-clipboard:copy="`${sameNs.service_name}:${sameNs.service_port}`"
                          v-clipboard:success="copyCommandSuccess"
                          v-clipboard:error="copyCommandError"
                          class="copy-btn el-icon-copy-document">
                    </span>
                  </div>
                  <span class="title">跨 NS 访问：</span>
                  <div v-for="(crossNs,indexCross) in allEndpoints"
                       :key="indexCross+'cross'">
                    <span
                          class="addr">{{ `${crossNs.service_name}.${namespace}:${crossNs.service_port}` }}</span>
                    <span v-clipboard:copy="`${crossNs.service_name}.${namespace}:${crossNs.service_port}`"
                          v-clipboard:success="copyCommandSuccess"
                          v-clipboard:error="copyCommandError"
                          class="copy-btn el-icon-copy-document">
                    </span>
                  </div>
                  <span slot="reference"><i class="show-more el-icon-more"></i></span>
                </el-popover>
              </div>
            </template>
            <div v-else>无</div>
          </div>
        </el-col>
      </el-row>

    </div>

    <div class="info-card" v-if="envSource ==='' || envSource === 'spock'">
      <div class="info-header">
        <span>基本操作</span>
      </div>
      <div class="info-body fundamental-ops">
        <template>
          <router-link v-if="checkPermissionSyncMixin({projectName: projectName, action: 'get_environment',resource:{name:envName,type:'env'}})"
                       :to="`/v1/projects/detail/${projectName}/envs/detail/${serviceName}/config${window.location.search}`">
            <el-button icon="iconfont iconshare1"
                       type="primary"
                       size="small"
                       plain>
              配置管理
            </el-button>
          </router-link>
          <el-tooltip v-else effect="dark" content="无权限操作" placement="top">
            <el-button icon="iconfont iconshare1"
                       class="permission-disabled"
                       type="primary"
                       size="small"
                       plain>
              配置管理
            </el-button>
          </el-tooltip>
          <el-button v-if="checkPermissionSyncMixin({projectName: projectName, action: 'get_environment',resource:{name:envName,type:'env'}})" @click="showExport"
                     icon="iconfont iconcloud icon-bold"
                     type="primary"
                     size="small"
                     plain>
            Yaml 导出
          </el-button>
          <el-tooltip v-else effect="dark" content="无权限操作" placement="top">
            <el-button icon="iconfont iconcloud icon-bold"
                       class="permission-disabled"
                       type="primary"
                       size="small"
                       plain>
               Yaml 导出
            </el-button>
          </el-tooltip>
          <router-link v-if="checkPermissionSyncMixin({projectName: projectName, action: 'get_service'})"
                       :to="`/v1/projects/detail/${originProjectName}/services?service_name=${serviceName}&rightbar=var`">
            <el-button icon="iconfont iconlink1 icon-bold"
                       type="primary"
                       size="small"
                       plain>
              服务管理
            </el-button>
          </router-link>
          <el-tooltip v-else effect="dark" content="无权限操作" placement="top">
            <el-button icon="iconfont iconlink1 icon-bold"
                       class="permission-disabled"
                       type="primary"
                       size="small"
                       plain>
              服务管理
            </el-button>
          </el-tooltip>
        </template>
      </div>
    </div>
    <div class="info-card">
      <div class="info-header display-flex">
        <span>服务实例</span>
        <el-popover placement="top"
                    trigger="hover"
                    class="middle">
          <div v-for="(color, status) in statusColorMap"
               :key="status"
               class="stat-tooltip-row">
            <span :class="['tooltip', color]"></span> {{ status }}
          </div>
          <i class="el-icon-question pointer middle"
             slot="reference"></i>
        </el-popover>
        <el-tooltip effect="dark" content="刷新服务实例" placement="top">
          <el-button icon="el-icon-refresh" type="text" @click="fetchServiceData">刷新</el-button>
        </el-tooltip>
      </div>
      <div class="info-body" v-loading="servicesLoading">
        <template>
          <el-table :data="currentService.scales"
                    row-key="name"
                    :expand-row-keys="expands"
                    @expand-change="expandScale"
                    style="width: 100%;">
            <el-table-column width="140"
                             prop="name"
                             label="名称">
              <template slot-scope="scope">
                <span>{{ scope.row.name }}</span>
              </template>
            </el-table-column>
            <el-table-column prop="images"
                             label="镜像">
              <template slot-scope="scope">
                <div v-for="(item,index) of scope.row.images"
                     :key="index"
                     class="image-row">
                  <template v-if="!item.edit">
                    <span class="service-name">{{ item.name }}</span>
                    <el-tooltip effect="light"
                                :content="item.image"
                                placement="top">
                      <span class="service-image">{{splitImg(item.image) }}</span>
                    </el-tooltip>
                    <el-button v-hasPermi="{projectName: projectName, action: 'manage_environment',resource:{name:envName,type:'env'},isBtn:true}" @click="showEditImage(item)"
                               type="primary"
                               plain
                               size="mini"
                               class="edit-btn"
                               icon="el-icon-edit"
                               circle></el-button>
                  </template>
                  <template v-else>
                    <span class="service-name">{{ item.name }}</span>
                    <el-select v-model.trim="item.image"
                               size="medium"
                               allow-create
                               filterable
                               placeholder="请选择版本"
                               class="select-image">
                      <el-option v-for="(image,index) in imgBucket[item.image_name]"
                                 :value="image.host+'/'+image.owner+'/'+image.name+':'+image.tag"
                                 :label="image.tag"
                                 :key="index">
                      </el-option>
                    </el-select>
                    <div>
                      <span>
                        <i title="取消"
                           @click="cancelEditImage(item)"
                           class="el-icon-circle-close icon-color icon-color-cancel operation">取消</i>
                      </span>
                      <span>
                        <i title="保存"
                           @click="saveImage(item,scope.row.name,scope.row.type)"
                           class="el-icon-circle-check icon-color icon-color-confirm operation">保存</i>
                      </span>
                    </div>
                  </template>

                </div>
              </template>
            </el-table-column>
            <el-table-column props="replicas"
                             width="125px"
                             label="副本数量">
              <template slot-scope="scope">
                <el-input-number v-if="checkPermissionSyncMixin({projectName: projectName, action: 'manage_environment',resource:{name:envName,type:'env'}})" size="mini"
                                 :min="0"
                                 @change="(currentValue)=>{scaleService(scope.row.name,scope.row.type,currentValue)}"
                                 v-model="scope.row.replicas"></el-input-number>
                <el-input-number v-else :disabled="true" size="mini"
                                 :min="0"
                                 @change="(currentValue)=>{scaleService(scope.row.name,scope.row.type,currentValue)}"
                                 v-model="scope.row.replicas"></el-input-number>
              </template>
            </el-table-column>
            <el-table-column  label="操作"
                             width="220px">
              <template slot-scope="scope">
                <el-button v-hasPermi="{projectName: projectName, action: 'manage_environment',resource:{name:envName,type:'env'},isBtn:true}" @click="restartService(scope.row.name,scope.row.type)"
                           size="mini">重启实例</el-button>
                <el-button v-hasPermi="{projectName: projectName, action: 'get_environment',resource:{name:envName,type:'env'},isBtn:true}" @click="showScaleEvents(scope.row.name,scope.row.type)"
                           size="mini">查看事件</el-button>
              </template>
            </el-table-column>
            <el-table-column label="详情"
                             props="pods"
                             type="expand"
                             width="80px">
              <template slot-scope="scope">
                <div v-if="activePod[scope.$index]"
                     class="info-body pod-container">

                  <span v-for="(pod,index) of scope.row.pods"
                        :key="index"
                        @click="selectPod(pod,scope.$index)"
                        :ref="pod.name"
                        :class="{pod:true, [pod.__color]:true, active: pod===activePod[scope.$index] }">
                  </span>
                  <transition name="fade">
                    <div v-if="activePod[scope.$index].name"
                         class="pod-info">
                      <el-row :class="['pod-row',`indicator-${activePod[scope.$index].name}`, activePod[scope.$index].__color]"
                              data-triangle-offset="5px"
                              ref="pod-row">
                        <el-col :span="12">
                          <div>
                            <span class="title">实例名称：</span>
                            <span class="content">{{ activePod[scope.$index].name }}</span>
                          </div>
                          <div>
                            <span class="title">实例 IP：</span>
                            <span class="content">{{ activePod[scope.$index].ip }}</span>
                          </div>
                          <div>
                            <span class="title">健康探测：</span>
                            <span
                              class="content"
                              :style="{ color: activePod[scope.$index].containers_ready ? 'inherit' : 'red' }"
                            >{{ activePod[scope.$index].containers_ready ? 'ready' : 'not ready' }}</span>
                            <el-tooltip effect="dark" :content="activePod[scope.$index].containers_message" placement="top">
                              <i
                                v-show="!activePod[scope.$index].containers_ready"
                                class="el-icon-warning-outline"
                                style="color: red; vertical-align: middle; cursor: pointer;"
                              ></i>
                            </el-tooltip>
                          </div>
                        </el-col>
                        <el-col :span="6">
                          <span class="title">运行时长：</span>
                          <span class="content">{{ activePod[scope.$index].age }}</span>
                          <div>
                            <span class="title">节点信息：</span>
                            <span class="content">{{ activePod[scope.$index].host_ip }}( {{activePod[scope.$index].node_name}} )</span>
                          </div>
                        </el-col>
                        <el-col :span="6"
                                class="op-buttons">
                          <el-tooltip v-if="!ephemeralContainersEnabled" effect="dark" content="实例所在的集群不支持 EphemeralContainers 功能，启动调试容器不可用" placement="top">
                            <span style="margin-left: auto;">
                              <el-badge value="alpha" class="ephemeral-badge">
                                <el-button :disabled="!ephemeralContainersEnabled" size="small">启动调试容器</el-button>
                              </el-badge>
                            </span>
                          </el-tooltip>
                          <el-badge v-else value="alpha" class="ephemeral-badge">
                          <el-button @click="openEphemeralContainersDialog(activePod[scope.$index].name)"
                                     v-hasPermi="{projectName: projectName, action: 'debug_pod',resource:{name:envName,type:'env'},isBtn:true, disabled: activePod[scope.$index].enable_debug_container || !activePod[scope.$index].canOperate}"
                                     :disabled="activePod[scope.$index].enable_debug_container || !activePod[scope.$index].canOperate"
                                     size="small">启动调试容器</el-button>
                          </el-badge>
                          <el-button style="margin-left: 40px;" v-hasPermi="{projectName: projectName, action: 'manage_environment',resource:{name:envName,type:'env'}}" @click="restartPod(activePod[scope.$index])"
                                     :disabled="!activePod[scope.$index].canOperate"
                                     size="small">重启</el-button>
                          <el-button v-hasPermi="{projectName: projectName, action: 'get_environment',resource:{name:envName,type:'env'}}" @click="showPodEvents(activePod[scope.$index])"
                                     size="small">查看事件</el-button>
                        </el-col>
                      </el-row>
                      <el-row v-for="container of activePod[scope.$index].containers"
                              :key="container.name"
                              :class="['container-row', container.__color || activePod[scope.$index].__color]">
                        <el-col :span="12">
                          <div>
                            <span class="title">容器名称：</span>
                            <span class="content">{{ container.name }}</span>
                          </div>
                          <div>
                            <span class="title">当前镜像：</span>
                            <span class="content">{{ container.imageShort }}</span>
                          </div>
                          <div v-if="container.message">
                            <span class="title">错误信息：</span>
                            <span class="content">{{ container.message }}</span>
                          </div>
                        </el-col>
                        <el-col :span="7">
                          <div>
                            <span class="title">状态：</span>
                            <span class="content">{{ container.status }}</span>
                            <el-tooltip effect="dark" content="未通过健康探测" placement="top">
                              <i
                                v-show="!container.ready"
                                class="el-icon-warning-outline"
                                style="color: red; vertical-align: middle; cursor: pointer;"
                              ></i>
                            </el-tooltip>
                          </div>
                          <div v-if="container.startedAtReadable">
                            <span class="title">启动时间：</span>
                            <span class="content">{{ container.startedAtReadable }}</span>
                          </div>
                        </el-col>
                        <el-col :span="5"
                                class="op-buttons">
                          <el-button v-hasPermi="{projectName: projectName, action: 'debug_pod',resource:{name:envName,type:'env'},isBtn:true}" @click="showContainerExec(activePod[scope.$index].name,container.name)"
                                     :disabled="!activePod[scope.$index].canOperate"
                                     icon="iconfont iconTerminal"
                                     size="small"> 调试</el-button>
                          <el-button v-hasPermi="{projectName: projectName, action: 'get_environment',resource:{name:envName,type:'env'},isBtn:true}" @click="showContainerLog(activePod[scope.$index].name,container.name)"
                                     :disabled="!activePod[scope.$index].canOperate"
                                     icon="el-icon-document"
                                     size="small">实时日志</el-button>
                        </el-col>
                      </el-row>
                    </div>
                  </transition>

                </div>
              </template>
            </el-table-column>
          </el-table>
        </template>
      </div>
    </div>

    <el-dialog :visible.sync="logModal.visible"
               :close-on-click-modal="false"
               width="70%"
               title="容器日志"
               class="log-dialog">
      <span slot="title"
            class="modal-title">
        <span class="unimportant">Pod 名称:</span>
        {{logModal.podName}}
        <span class="unimportant">容器:</span>
        {{logModal.containerName}}
        <i class="el-icon-full-screen screen"
           @click="fullScreen('logModal')"></i>
      </span>
      <ContainerLog id="logModal"
                    :podName="logModal.podName"
                    :containerName="logModal.containerName"
                    :visible="logModal.visible"/>
    </el-dialog>

    <el-dialog :visible.sync="execModal.visible"
               width="70%"
               :close-on-click-modal="false"
               title="Pod 调试"
               class="log-dialog">
      <span slot="title"
            class="modal-title">
        <span class="unimportant">Pod 名称:</span>
        {{execModal.podName}}
        <span class="unimportant">容器:</span>
        {{execModal.containerName}}
        <i class="el-icon-full-screen screen"
           @click="fullScreen(execModal.podName +'-debug')"></i>
      </span>
      <XtermDebug :id="execModal.podName +'-debug'"
                   :projectName="projectName"
                   :envName="envName"
                   :namespace="namespace"
                   :serviceName="serviceName"
                   :containerName="execModal.containerName"
                   :podName="execModal.podName"
                   :clusterId="clusterId"
                   :visible="execModal.visible"
                   ref="debug"/>
      <div class="download-content">
        <el-input v-model="downloadFilePath" placeholder="输入文件在容器中的绝对路径"></el-input>
        <el-button type="primary" @click="downloadFile(execModal.podName, execModal.containerName)" :disabled="!downloadFilePath" plain>下载</el-button>
      </div>
    </el-dialog>

    <el-dialog :visible.sync="exportModal.visible"
               width="70%"
               title="YAML 配置导出"
               class="export-dialog">
      <h1 v-if="exportModal.textObjects.length === 0"
          v-loading="exportModal.loading"
          class="nothing">
        {{ exportModal.loading ? '' : notSupportYaml }}
      </h1>
      <template v-else>
        <div class="op-row expanded">
          <el-button @click="copyAllYAML"
                     plain
                     type="primary"
                     size="medium"
                     class="at-right">复制全部</el-button>
        </div>
        <div v-for="(obj, i) of exportModal.textObjects"
             :key="obj.originalText"
             class="config-viewer">
          <div>
            <div :class="{'op-row': true, expanded: obj.expanded}">
              <el-button @click="toggleYAML(obj)"
                         type="text"
                         icon="el-icon-caret-bottom">
                {{ obj.expanded ? '收起' : '展开' }}
              </el-button>
              <el-button @click="copyYAML(obj, i)"
                         type="primary"
                         plain
                         size="small"
                         class="at-right">复制</el-button>
            </div>
            <Editor v-show="obj.expanded"
                    :value="obj.readableText"
                    :options="exportModal.editorOption"
                    @init="editorInit($event, obj)"
                    lang="yaml"
                    theme="tomorrow_night"
                    width="100%"
                    height="800"></Editor>
          </div>
        </div>
      </template>
    </el-dialog>

    <el-dialog :visible.sync="eventsModal.visible"
               width="70%"
               title="查看事件"
               class="events-dialog">
      <span slot="title"
            class="modal-title">
        <span class="unimportant">实例名称:</span>
        {{ eventsModal.name }}
      </span>

      <div v-if="eventsModal.data.length === 0"
           class="events-no-data">
        <span class="el-table__empty-text">暂时没有事件</span>
      </div>
      <el-table :data="eventsModal.data"
                v-else>
        <el-table-column prop="message"
                         label="消息"></el-table-column>
        <el-table-column prop="reason"
                         label="状态"
                         width="240"></el-table-column>
        <el-table-column prop="count"
                         label="总数"
                         width="70"></el-table-column>
        <el-table-column prop="firstSeenReadable"
                         label="最早出现于"
                         width="160"></el-table-column>
        <el-table-column prop="lastSeenReadable"
                         label="最近出现于"
                         width="160"></el-table-column>
      </el-table>

    </el-dialog>

  </div>
</template>

<script>
import ContainerLog from '../serviceDetail/containerLog.vue'
import { restartPodAPI, restartServiceAPI, scaleServiceAPI, scaleEventAPI, podEventAPI, exportYamlAPI, imagesAPI, updateServiceImageAPI, getServiceInfo, listProductAPI, checkEphemeralContainersAPI, startEphemeralContainersDebugAPI } from '@api'
import moment from 'moment'
import Editor from 'vue2-ace-bind'
import bus from '@utils/eventBus'
import store from 'storejs'
import { fullScreen } from '@/utilities/fullScreen'
export default {
  data () {
    return {
      fullScreen,
      currentService: {
        ingress: [],
        pods: [],
        service_name: '',
        service_endpoints: []
      },
      expands: [],
      activePod: {},
      imgBucket: {},
      logModal: {
        visible: false,
        podName: null,
        containerName: null
      },
      execModal: {
        visible: false,
        podName: null,
        containerName: null
      },
      exportModal: {
        textObjects: [],
        visible: false,
        loading: false,
        editorOption: {
          showLineNumbers: true,
          showFoldWidgets: true,
          showGutter: true,
          displayIndentGuides: true,
          showPrintMargin: false,
          readOnly: true,
          tabSize: 2,
          maxLines: Infinity
        }
      },
      eventsModal: {
        visible: false,
        name: '',
        data: []
      },
      window: window,
      statusColorMap: {
        running: 'green',
        pending: 'yellow',
        failed: 'red',
        unstable: 'light-red',
        unknown: 'purple',
        terminating: 'gray',
        'pod not ready': 'dark-red'
      },
      registryId: '',
      servicesLoading: true,
      ephemeralContainersEnabled: false,
      ephemeralContainersDialog: {
        visible: false,
        source: 'builtin',
        image: ''
      },
      downloadFilePath: ''
    }
  },

  computed: {
    allHosts () {
      if (this.currentService.ingress) {
        return this.currentService.ingress.reduce((carry, ing) => carry.concat(ing.host_info), [])
      } else {
        return []
      }
    },
    allEndpoints () {
      if (this.currentService.service_endpoints) {
        return this.currentService.service_endpoints.reduce(
          (carry, point) => {
            if (point.endpoints) {
              return carry.concat(point.endpoints
              )
            }
            return carry
          }, []
        )
      } else {
        return []
      }
    },
    projectName () {
      return (this.$route.params.project_name ? this.$route.params.project_name : this.$route.query.projectName)
    },
    originProjectName () {
      return (this.$route.query.originProjectName ? this.$route.query.originProjectName : this.projectName)
    },
    clusterId () {
      return this.$route.query.clusterId
    },
    serviceName () {
      return this.$route.params.service_name
    },
    envName () {
      return this.$route.query.envName
    },
    workLoadType () {
      return this.$route.query.workLoadType
    },
    envSource () {
      return this.$route.query.envSource || ''
    },
    isProd () {
      return this.$route.query.isProd === 'true'
    },
    notSupportYaml () {
      return '没有找到数据'
    },
    namespace () {
      return this.$route.query.namespace
    }
  },

  methods: {
    downloadFile (podName, containerName) {
      const token = store.get('userInfo').token
      const url = `/api/aslan/environment/kube/pods/${podName}/file?projectName=${
        this.projectName
      }&envName=${
        this.envName
      }&container=${containerName}&path=${encodeURIComponent(
        this.downloadFilePath
      )}&token=${token}`
      const aEle = document.createElement('a')
      if (aEle.download !== undefined) {
        aEle.setAttribute('href', url)
        aEle.setAttribute('download', this.downloadFilePath)
        document.body.appendChild(aEle)
        aEle.click()
        document.body.removeChild(aEle)
      }
    },
    copyCommandSuccess (event) {
      this.$message({
        message: '地址已成功复制到剪贴板',
        type: 'success'
      })
    },
    copyCommandError (event) {
      this.$message({
        message: '地址复制失败',
        type: 'error'
      })
    },
    splitImg (img) {
      if (img) {
        if (img.includes('/')) {
          const length = img.split('/').length
          return img.split('/')[length - 1]
        } else {
          return img
        }
      }
    },
    fetchServiceData () {
      this.servicesLoading = true
      const projectName = this.projectName
      const serviceName = this.serviceName
      const workLoadType = this.workLoadType
      const envName = this.envName ? this.envName : ''
      const envType = this.isProd ? 'prod' : ''
      getServiceInfo(projectName, serviceName, envName, envType, workLoadType).then((res) => {
        if (res.scales) {
          if (res.scales.length > 0 && res.scales[0].pods.length > 0) {
            this.expands = [res.scales[0].name]
            this.$set(this.activePod, 0, res.scales[0].pods[0])
          }
          res.scales.forEach(scale => {
            scale.pods.forEach(pod => {
              pod.status = pod.status.toLowerCase()
              pod.__color = this.statusColorMap[!pod.pod_ready && pod.status === 'running' ? 'pod not ready' : pod.status]
              pod.canOperate = !(pod.status in {
                pending: 1,
                terminating: 1
              })
              pod.containers.forEach(con => {
                con.edit = false
                con.image2Apply = con.image
                con.imageShort = con.image.split('/').pop()
                con.status = con.status.toLowerCase()
                con.__color = this.statusColorMap[!pod.pod_ready && pod.status === 'running' ? 'pod not ready' : con.status]
                con.startedAtReadable = con.started_at
                  ? moment(con.started_at, 'X').format('YYYY-MM-DD HH:mm:ss')
                  : ''
              })
            })
          })
        } else {
          res.scales = []
        }
        this.currentService = res
        this.servicesLoading = false
      })
    },
    expandScale (row, rows) {
      const rowIndex = this.currentService.scales.indexOf(row)
      const pods = row.pods
      if (pods.length > 0) {
        this.$set(this.activePod, rowIndex, pods[0])
      }
    },
    getImages (containerName) {
      const containerNames = [containerName]
      imagesAPI(containerNames, this.registryId).then(res => {
        this.$set(this.imgBucket, containerName, res)
      })
    },
    showEditImage (item) {
      this.$set(item, 'edit', true)
      this.getImages(item.image_name)
    },
    cancelEditImage (item) {
      this.$set(item, 'edit', false)
    },
    saveImage (item, scaleName, typeUppercase) {
      const envType = this.isProd ? 'prod' : ''
      const envName = this.envName
      const projectName = this.projectName
      const type = typeUppercase.toLowerCase()
      item.edit = false
      this.$message({
        message: '正在更新镜像',
        duration: 3500
      })
      const payload = {
        product_name: this.projectName,
        service_name: this.serviceName,
        container_name: item.name,
        name: scaleName,
        image: item.image
      }
      if (this.envName) {
        payload.env_name = this.envName
      }
      updateServiceImageAPI(payload, type, projectName, envName, envType).then((res) => {
        this.fetchServiceData()
        this.$message({
          message: '镜像更新成功',
          type: 'success'
        })
      })
    },
    restartService (scaleName, type) {
      this.$confirm('确定重启实例吗?', '重启', {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'warning'
      }).then(() => {
        const projectName = this.projectName
        const serviceName = this.serviceName
        const envName = this.envName ? this.envName : ''
        const envType = this.isProd ? 'prod' : ''
        restartServiceAPI(projectName, serviceName, envName, scaleName, type, envType).then((res) => {
          this.fetchServiceData()
          this.$message({
            message: '重启实例成功',
            type: 'success'
          })
        })
      }).catch(() => {
        this.$message({
          type: 'info',
          message: '已取消重启'
        })
      })
    },
    scaleService (scaleName, type, scaleNumber) {
      const projectName = this.projectName
      const serviceName = this.serviceName
      const envName = this.envName ? this.envName : ''
      const envType = this.isProd ? 'prod' : ''
      scaleServiceAPI(projectName, serviceName, envName, scaleName, scaleNumber, type, envType).then((res) => {
        this.fetchServiceData()
        this.$message({
          message: '伸缩服务成功',
          type: 'success'
        })
      })
    },
    selectPod (target, index) {
      this.activePod[index] = target
      // https://stackoverflow.com/questions/5041494
      // https://betterprogramming.pub/how-to-fix-the-failed-to-read-the-cssrules-property-from-cssstylesheet-error-431d84e4a139
      const sheet = Array.from(document.styleSheets).filter((styleSheet) => !styleSheet.href || styleSheet.href.startsWith(window.location.origin))[0]
      const len = sheet.cssRules.length
      sheet.insertRule(`.service-details-container .pod-info .indicator-${target.name}::before
          { left: ${this.$refs[target.name][0].offsetLeft + 4}px!important; }`, len)
      sheet.insertRule(`.service-details-container .pod-info
          { top: ${this.$refs[target.name][0].offsetTop + 30}px!important; }`, len + 1)
    },
    restartPod (pod) {
      this.$confirm('确定重启吗?', '重启', {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'warning'
      }).then(() => {
        const ownerQuery = this.envName ? `&envName=${this.envName}` : ''
        const projectName = `${this.projectName}${ownerQuery}`
        const podName = pod.name
        const envName = this.envName
        const envType = this.isProd ? 'prod' : ''
        restartPodAPI(podName, projectName, envName, envType).then((res) => {
          this.fetchServiceData()
          this.$message({
            message: '重启成功',
            type: 'success'
          })
        })
      }).catch(() => {
        this.$message({
          type: 'info',
          message: '已取消重启'
        })
      })
    },
    showContainerLog (pod_name, container_name) {
      this.logModal.visible = true
      this.logModal.podName = pod_name
      this.logModal.containerName = container_name
    },
    showContainerExec (pod_name, container_name) {
      this.execModal.visible = true
      this.execModal.podName = pod_name
      this.execModal.containerName = container_name
    },
    showExport () {
      const projectName = this.projectName
      const serviceName = this.serviceName
      const envName = this.envName ? this.envName : ''
      const envType = this.isProd ? 'prod' : ''
      this.exportModal.visible = true
      this.exportModal.textObjects = []
      this.exportModal.loading = true
      exportYamlAPI(projectName, serviceName, envName, envType).then((res) => {
        this.exportModal.textObjects = res.map(txt => ({
          originalText: txt,
          readableText: txt.replace(/\\n/g, '\n').replace(/\\t/g, '\t'),
          expanded: true,
          editor: null
        }))
        this.exportModal.loading = false
      })
    },
    editorInit (e, obj) {
      obj.editor = e
    },
    copyYAML (obj, i) {
      const e = obj.editor
      e.setValue(obj.originalText)
      e.focus()
      e.selectAll()
      if (document.execCommand('copy')) {
        this.$message.success('复制成功')
      } else {
        this.$message.error('复制失败')
      }
      e.setValue(obj.readableText)
    },
    toggleYAML (obj) {
      obj.expanded = !obj.expanded
    },
    copyAllYAML () {
      const textArea = document.createElement('textarea')
      textArea.value = this.exportModal.textObjects
        .map(obj => obj.originalText)
        .join('\n\n---\n\n')
      document.body.appendChild(textArea)
      textArea.focus()
      textArea.select()

      if (document.execCommand('copy')) {
        this.$message.success('复制成功')
      } else {
        this.$message.error('复制失败')
      }
      document.body.removeChild(textArea)
    },
    showPodEvents (pod) {
      const projectName = this.projectName
      const podName = pod.name
      const envName = this.envName ? this.envName : ''
      const envType = this.isProd ? 'prod' : ''
      this.eventsModal.visible = true
      podEventAPI(projectName, podName, envName, envType).then((res) => {
        this.eventsModal.data = res.map(row => {
          row.firstSeenReadable = moment(row.first_seen, 'X').format('YYYY-MM-DD HH:mm')
          row.lastSeenReadable = moment(row.last_seen, 'X').format('YYYY-MM-DD HH:mm')
          return row
        })
      })
    },
    showScaleEvents (scaleName, type) {
      const projectName = this.projectName
      const envName = this.envName ? this.envName : ''
      const envType = this.isProd ? 'prod' : ''
      this.eventsModal.visible = true
      this.eventsModal.name = scaleName
      scaleEventAPI(projectName, scaleName, envName, type, envType).then((res) => {
        this.eventsModal.data = res.map(row => {
          row.firstSeenReadable = moment(row.first_seen, 'X').format('YYYY-MM-DD HH:mm')
          row.lastSeenReadable = moment(row.last_seen, 'X').format('YYYY-MM-DD HH:mm')
          return row
        })
      })
    },
    getEnvInfo () {
      listProductAPI(this.projectName).then(res => {
        this.registryId = res.find(re => re.name === this.envName).registry_id || ''
      })
    },
    openEphemeralContainersDialog (podName) {
      this.ephemeralContainersDialog.visible = true
      this.ephemeralContainersDialog.podName = podName
    },
    checkEphemeralContainers () {
      checkEphemeralContainersAPI(this.clusterId).then(res => {
        this.ephemeralContainersEnabled = res
      })
    },
    startEphemeralContainersDebug () {
      const payload = {
        projectName: this.projectName,
        envName: this.envName,
        podName: this.ephemeralContainersDialog.podName,
        image: this.ephemeralContainersDialog.image
      }
      this.$refs.ephemeralContainerForm.validate((valid) => {
        if (valid) {
          startEphemeralContainersDebugAPI(payload).then(res => {
            this.$message.success('创建成功')
            this.fetchServiceData()
            this.ephemeralContainersDialog = {
              visible: false,
              source: 'builtin',
              image: ''
            }
          }, () => {
            this.ephemeralContainersDialog = {
              visible: false,
              source: 'builtin',
              image: ''
            }
          })
        } else {
          return false
        }
      })
    }
  },
  created () {
    this.getEnvInfo()
    this.fetchServiceData()
    this.checkEphemeralContainers()
    bus.$emit('set-topbar-title',
      {
        title: '',
        breadcrumb: [
          { title: '项目', url: '/v1/projects' },
          { title: this.projectName, isProjectName: true, url: `/v1/projects/detail/${this.projectName}/detail` },
          { title: '环境', url: `/v1/projects/detail/${this.projectName}/envs/detail` },
          { title: this.envName, url: `/v1/projects/detail/${this.projectName}/envs/detail?envName=${this.envName}` },
          { title: this.serviceName, url: '' }
        ]
      })
  },
  components: {
    ContainerLog,
    Editor
  }
}
</script>

<style lang="less" scoped>
@import "~@assets/css/component/service-detail.less";

.ephemeralContainers-dialog {
  /deep/ .el-dialog__body {
    padding: 0 20px;
  }
}

/deep/.ephemeral-badge {
  margin-left: auto;

  .el-badge__content {
    color: #06f;
    background-color: #fff;
    border: 1px solid #06f;
    border-radius: 4px;
  }
}

/deep/.el-dialog__headerbtn {
  top: 18px;
  font-size: 20px;
}

.display-flex {
  display: flex;
  align-items: center;

  .middle {
    flex: 1 1 auto;
  }

  /deep/.el-button {
    padding: 0;
  }
}
</style>
